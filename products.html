<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4PJ8JE8SW8"></script>
    <script src="../src/js/googleAnalytics.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.glitch.global/8352fc0e-bebe-4680-ae0b-269da8b54259/ScrollSmoother.min.js"></script>
    <script src="https://cdn.glitch.global/8352fc0e-bebe-4680-ae0b-269da8b54259/SplitText.min.js"></script>

    <link rel="stylesheet" href="src/css/main.css" />
    <link rel="stylesheet" href="src/css/productsMainPage.css" />
  </head>

  <body>
    <section class="splashScreen">
      <p>Strumix</p>
    </section>
    <main id="smooth-wrapper">
      <div id="smooth-content">
        <section class="hero">
          <p>strumix</p>
          <p>کاتالوگ محصولات</p>
        </section>
        <section class="selection">
          <div class="topSectionContainer">
            <div class="main" id="scrollContainer">
              <div id="allProducts" class="buttonCards active">
                <p>همه‌ی محصولات</p>
                <p>همه‌ی محصولات</p>
              </div>
              <div id="concreteAdditive" class="buttonCards">
                <p>افزودنی بتن</p>
                <p>افزودنی بتن</p>
              </div>
              <div id="constructionChemicals" class="buttonCards">
                <p>مواد شیمیایی صنعت ساخمان</p>
                <p>مواد شیمیایی صنعت ساخمان</p>
              </div>
              <div id="waterstop" class="buttonCards">
                <p>واتراستاپ</p>
                <p>واتراستاپ</p>
              </div>
              <div id="plastic-spacers" class="buttonCards">
                <p>اسپیسر پلاستیکی بتن</p>
                <p>اسپیسر پلاستیکی بتن</p>
              </div>
              <div id="raw-materials" class="buttonCards">
                <p>مواد اولیه افزودنی بتن و شیمی ساختمان</p>
                <p>مواد اولیه افزودنی بتن و شیمی ساختمان</p>
              </div>
            </div>
          </div>
          <div id="bottomSection"></div>
          <hr />
          <div class="counter">12 محصول</div>
        </section>
        <section class="productList"></section>
      </div>
    </main>
    <script>
      const scrollContainer = document.getElementById("scrollContainer");

      scrollContainer.addEventListener("wheel", (event) => {
        event.preventDefault();

        scrollContainer.scrollLeft += -event.deltaY;
      });
      //---------------------------------------------------------------------------
      gsap.registerPlugin(ScrollTrigger, ScrollSmoother, SplitText);
      window.addEventListener("load", (event) => {
        gsap.to(".splashScreen", {
          y: "-100%",
          delay: 1,
          duration: 1,
          ease: "power3.out",
        });
        ScrollSmoother.create({
          wrapper: "#smooth-wrapper",
          contect: "#smooth-content",
          smooth: 1,
          effects: true,
          smoothTouch: false,
        });
        gsap.from(
          new SplitText(".hero > p:nth-child(2)", {
            type: "chars",
            tagName: "span",
            tag: "span",
          }).chars,
          {
            delay: 1.2,
            opacity: 0.2,
            duration: 0.5,
            ease: "power3.out",
            stagger: 0.15,
          }
        );
      });
      //---------------------------------------------------------------------------
      function fetchDataAndRender(subCategory) {
        return async () => {
          try {
            const data = await (await fetch("./products/products.json")).json();
            const categoryLists = data.categories.filter(
              (category) => category.subCategory === subCategory
            );
            const bottomSectionContainer = document.getElementById("bottomSection");
            bottomSectionContainer.className = "bottomSectionContainer";

            bottomSectionContainer.innerHTML = "";

            let buttons = document.querySelectorAll(".selection .buttonCards");
            buttons.forEach((button) => button.classList.remove("active"));
            document.getElementById(subCategory).classList.add("active");

            const productList = document.querySelector(".productList");
            productList.innerHTML = "";

            let productCount = 0;

            categoryLists.forEach((category) => {
              const buttonCard = document.createElement("div");
              buttonCard.className = "buttonCards";

              [1, 2].forEach(() => {
                const paragraph = document.createElement("p");
                paragraph.textContent = category.faName;
                buttonCard.id = category.name;
                buttonCard.appendChild(paragraph);
              });

              bottomSectionContainer.appendChild(buttonCard);

              productCount += renderProducts(category.products);

              document
                .getElementById(category.name)
                .addEventListener("click", () => fetchAndLogProducts(category.name));
            });

            const counter = document.querySelector(".counter");
            counter.textContent = `${productCount} محصول`;
          } catch (error) {
            console.error("Error fetching data:", error);
          }
        };
      }

      const renderProducts = (products) => {
        const productList = document.querySelector(".productList");

        let categoryProductCount = 0;

        products.forEach((product) => {
          const div = document.createElement("div");
          const link = document.createElement("a");
          link.href = `products/${product.url}`;
          const img = document.createElement("img");
          img.src = `./assets/productImg/${product.image}`;
          img.alt = `${product.name.en} image, تصویر ${product.name.fa}`;

          img.setAttribute("loading", "lazy");
          link.appendChild(img);
          [product.name.en, product.name.fa].forEach((name) => {
            const p = document.createElement("p");
            p.className = "englishText";
            p.textContent = name;
            link.appendChild(p);
          });
          div.appendChild(link);
          productList.appendChild(div);

          categoryProductCount++;
        });

        return categoryProductCount;
      };

      document
        .getElementById("concreteAdditive")
        .addEventListener("click", fetchDataAndRender("concreteAdditive"));
      document
        .getElementById("constructionChemicals")
        .addEventListener("click", fetchDataAndRender("constructionChemicals"));
      document
        .getElementById("waterstop")
        .addEventListener("click", fetchDataAndRender("waterstop"));

      const fetchData = async () => {
        try {
          const data = await (await fetch("./products/products.json")).json();
          const productList = document.querySelector(".productList");
          productList.innerHTML = "";

          let buttons = document.querySelectorAll(".selection .buttonCards");
          buttons.forEach((button) => button.classList.remove("active"));
          document.getElementById("allProducts").classList.add("active");

          const bottomSectionContainer = document.getElementById("bottomSection");
          bottomSectionContainer.className = "";
          bottomSectionContainer.innerHTML = "";

          const uniqueNames = new Set();

          data.categories.forEach((category) => {
            category.products.forEach((product) => {
              if (!uniqueNames.has(product.name.en)) {
                uniqueNames.add(product.name.en);

                const div = document.createElement("div");
                const link = document.createElement("a");
                link.href = `products/${product.url}`;
                const img = document.createElement("img");
                img.src = `./assets/productImg/${product.image}`;
                img.alt = `${product.name.en} image, تصویر ${product.name.fa}`;
                img.setAttribute("loading", "lazy");
                link.appendChild(img);

                [product.name.en, product.name.fa].forEach((name) => {
                  const p = document.createElement("p");
                  p.className = "englishText";
                  p.textContent = name;
                  link.appendChild(p);
                });

                div.appendChild(link);
                productList.appendChild(div);
              }
            });
          });

          const productCount = uniqueNames.size;
          const counter = document.querySelector(".counter");
          counter.textContent = `${productCount} محصول`;
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      };

      const fetchAndLogProducts = async (categoryName) => {
        try {
          let buttons = document.querySelectorAll(".selection .buttonCards");
          buttons.forEach((button) => button.classList.remove("active"));
          document.getElementById(categoryName).classList.add("active");

          const data = await (await fetch("./products/products.json")).json();
          const category = data.categories.find((cat) => cat.name === categoryName);

          const counter = document.querySelector(".counter");
          counter.textContent = `${category.products.length} محصول`;

          if (category) {
            const productList = document.querySelector(".productList");
            productList.innerHTML = "";
            renderProducts(category.products);
          } else {
            console.log(`Category "${categoryName}" not found.`);
          }
        } catch (error) {
          console.error("Error yfetching or logging data:", error);
        }
      };

      const resetData = () => {
        const bottomSectionContainer = document.getElementById("bottomSection");
        bottomSectionContainer.className = "";
        bottomSectionContainer.innerHTML = "";
      };

      document.getElementById("allProducts").addEventListener("click", fetchData);
      document.getElementById("plastic-spacers").addEventListener("click", () => {
        fetchAndLogProducts("plastic-spacers");
        resetData();
      });

      document.getElementById("raw-materials").addEventListener("click", () => {
        fetchAndLogProducts("raw-materials");
        resetData();
      });
      fetchData();
    </script>
  </body>
</html>
