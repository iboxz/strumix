<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <meta
      name="robots"
      content="noindex, nofollow"
    />
    <meta
      name="googlebot"
      content="noindex,indexifembedded"
    />
    <title>ادمین - صفحه ادیت محصولات</title>

    <link
      rel="icon"
      href="../assets/VectorLogo-favicon.svg"
      type="image/svg+xml"
      sizes="any"
    />

    <link
      rel="stylesheet"
      href="../src/css/main.css?v=1.0.13"
    />
    <link
      rel="stylesheet"
      href="../src/css/products.css?v=1.0.13"
    />

    <script src="../src/js/chart.js"></script>
    <script
      defer=""
      src="../src/js/lineChart.js"
    ></script>

    <style>
      main {
        padding-bottom: 15vmin;
      }
      .edit-btn,
      .save-btn {
        margin: 5px;
        padding: 5px 10px;
        cursor: pointer;
      }
      .edit-btn {
        background-color: #4caf50;
        color: white;
      }
      .save-btn {
        background-color: #008cba;
        color: white;
        display: none;
      }
      .editable {
        border: 1px dashed #000;
      }
      .add-btn {
        margin: 2px;
        padding: 2px 4px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 14px;
      }

      .add-btn:hover {
        background-color: #45a049;
      }
      .button-container {
        z-index: 99;
        position: relative;
      }
      .hidden {
        display: none;
      }

      #editPanel {
        position: fixed;
        top: 20%;
        left: 20%;
        width: 60%;
        padding: 20px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        z-index: 1000;
      }

      #editPanel label {
        display: block;
        margin-top: 10px;
      }

      #editPanel input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
      }
      .editPanelBtn {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 500px;
        background-color: #f0f0f0;
        position: fixed;
        bottom: 1vmin;
        left: 1vmin;
        padding: 1vmin;
        display: flex;
        flex-wrap: wrap;
        direction: ltr;
        border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
      }

      .editPanelBtn button,
      .editPanelBtn input[type="file"],
      .editPanelBtn select {
        background-color: #088f9e;
        color: #fff;
        border: none;
        padding: 5px 10px;
        margin-bottom: 5px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
        transition: background-color 0.3s;
        width: 100%;
      }

      .editPanelBtn hr {
        margin-bottom: 5px;
      }
      .editPanelBtn button:hover,
      .editPanelBtn input[type="file"]:hover,
      .editPanelBtn select:hover {
        background-color: #066f7a;
      }

      .editPanelBtn span {
        font-size: 16px;
        font-family: Arial, Helvetica, sans-serif;
        text-transform: capitalize;
        margin-bottom: 5px;
      }
      #message {
        margin-top: 10px;
        width: 100%;
        border: 2px black solid;
        border-radius: 5px;
        padding: 6px;
        background: white;
      }
      input[type="file"]::file-selector-button {
        border: white 1px solid;
        color: white;
        background: transparent;
        border-radius: 5px;
      }

      input[type="file"]:hover::file-selector-button {
        border: black 1px solid;
        color: black;
      }
      select:hover {
        color: white !important;
      }
      #message {
        width: 100%;
        border: 1px black solid;
        border-radius: 5px;
        padding: 6px;
        margin-bottom: 5px;
        background: rgb(255, 255, 255);
      }
      .panelHidden {
        display: none;
      }
      .fleshDown {
        content: url(../assets/VectorFlesh5.svg);
        vertical-align: middle;
        height: 100%;
        width: 20px;
        height: 20px;
        min-width: 10p;
        padding: 3px;
        border: 1px solid black;
        border-radius: 50vmin;
        margin-left: auto;
        transition: 0.5s ease;
      }
      .fleshDown.active {
        transform: rotate(180deg);
      }
      .button-container-main > button {
        font-family: YekanBakhFaNum;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <main id="smooth-wrapper"></main>

    <div class="editPanelBtn">
      <span
        id="toggleContainerButton"
        class="fleshDown"
      ></span>
      <hr />
      <span>Add products:</span>
      <button>
        <span class="text-container">
          <span class="text">Add Product</span>
        </span>
      </button>
      <hr />
      <span>Edit products:</span>
      <select id="productSelect"></select>
      <hr />
      <span>product image:</span>
      <input
        type="file"
        title="file"
        id="file"
        name="uploadFile"
        accept=".png, .jpg"
      />
      <hr />
      <span>product catalog:</span>
      <input
        type="file"
        title="file"
        id="file"
        name="uploadFile"
        accept=".pdf"
      />
      <hr />
      <button id="toggleButton">
        <span class="text-container">
          <span class="text">Edit Chart Data</span>
        </span>
      </button>

      <hr />
      <button onclick="saveAllSections()">
        <span class="text-container">
          <span class="text">Save</span>
        </span>
      </button>
      <div id="message"></div>
      <div
        id="editPanel"
        class="hidden"
      >
        <label for="labels">Labels (comma separated):</label>
        <input
          type="text"
          id="labels"
        />

        <label for="labelYellow">Label Yellow:</label>
        <input
          type="text"
          id="labelYellow"
        />

        <label for="labelRed">Label Red:</label>
        <input
          type="text"
          id="labelRed"
        />

        <label for="dataYellow">Data Yellow (comma separated):</label>
        <input
          type="text"
          id="dataYellow"
        />

        <label for="dataRed">Data Red (comma separated):</label>
        <input
          type="text"
          id="dataRed"
        />

        <label for="titleText">Title:</label>
        <input
          type="text"
          id="titleText"
        />

        <button id="saveButton">Save</button>
      </div>
    </div>

    <script>
      const username = sessionStorage.getItem("username");
      const password = sessionStorage.getItem("password");

      /*       document.addEventListener("DOMContentLoaded", function () {
        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        fetch("login.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((text) => {
            if (text != "true") {
              document.body.innerHTML = "";

              document.body.innerHTML =
                '<a style="display: block; width: 100%; text-align: center; font-size: larger;" href="index.html">لاگین کنید</a>';
            }
          })
          .catch((error) => console.error("Error:", error));
      }); */

      // تعریف متغیرهای مورد نیاز
      var pageUrl = "";

      // تابع نمایش پیام‌ها
      function displayMessage(message) {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML += message + "<br>";
      }

      // تابع حذف ویژگی‌های edit و تمیز کردن المان‌ها
      function cleanEditables() {
        const selectors = "h1, h2, h3, h4, p, ul, td";
        document.querySelectorAll(selectors).forEach((element) => {
          element.removeAttribute("contentEditable");
          element.classList.remove("editable");
          if (!element.classList.length) element.removeAttribute("class");
        });
        [".button-container-add", ".button-container-main", ".button-container", ".add-btn"].forEach((selector) => {
          document.querySelectorAll(selector).forEach((btn) => btn.remove());
        });
      }

      // تابع آپلود فایل PDF
      async function uploadPDF() {
        const fileInput = document.getElementById("file");
        const file = fileInput.files[0];
        if (!file || file.type !== "application/pdf") {
          displayMessage("لطفاً یک فایل PDF معتبر انتخاب کنید.");
          return;
        }
        const formData = new FormData();
        formData.append("file", file);
        formData.append("title", pageUrl);
        formData.append("username", username);
        formData.append("password", password);
        try {
          const response = await fetch("uploadProductPdf.php", { method: "POST", body: formData });
          const text = await response.text();
          if (text.includes("PDF uploaded successfully!")) {
            displayMessage("PDF با موفقیت بارگذاری شد!");
          } else {
            displayMessage(text);
            throw new Error(`Upload response: ${text}`);
          }
        } catch (error) {
          displayMessage(error);
        }
      }

      // تابع آپلود محتوای صفحه
      async function uploadContent() {
        const body = document.querySelector("main").innerHTML;
        const formData = new FormData();
        formData.append("url", pageUrl);
        formData.append("body", body);
        ["labels", "labelYellow", "labelRed", "dataYellow", "dataRed", "titleText"].forEach((param) => {
          formData.append(param, window[param]);
        });
        formData.append("username", username);
        formData.append("password", password);
        try {
          const response = await fetch("uploadNewProduct.php", { method: "POST", body: formData });
          const text = await response.text();
          displayMessage(text);
          if (!text.includes("صفحه با موفقیت به‌روزرسانی شد")) {
            throw new Error(text);
          }
        } catch (error) {
          displayMessage(error.message);
        }
      }

      // تابع پر کردن ورودی‌ها
      function populateInputs() {
        ["labels", "labelYellow", "labelRed", "dataYellow", "dataRed", "titleText"].forEach((id) => {
          document.getElementById(id).value = window[id];
        });
      }

      // رویداد برای دکمه نمایش/مخفی کردن پنل ویرایش
      document.getElementById("toggleButton").addEventListener("click", () => {
        const panel = document.getElementById("editPanel");
        panel.classList.toggle("hidden");
        if (!panel.classList.contains("hidden")) populateInputs();
      });

      // رویداد برای دکمه ذخیره تغییرات
      document.getElementById("saveButton").addEventListener("click", () => {
        window.labels = document
          .getElementById("labels")
          .value.split(",")
          .map((item) => item.trim());
        ["labelYellow", "labelRed", "titleText"].forEach((id) => {
          window[id] = document.getElementById(id).value;
        });
        ["dataYellow", "dataRed"].forEach((id) => {
          window[id] = document.getElementById(id).value.split(",").map(Number);
        });
        initializeChart();
        document.getElementById("editPanel").classList.add("hidden");
      });

      // تابع فعال‌سازی ویرایش همه بخش‌ها
      function editAllSections() {
        document.querySelectorAll("h1, h2, h3, h4, p, ul, td").forEach((element) => {
          element.contentEditable = true;
          element.classList.add("editable");
        });
      }

      // تابع ایجاد دکمه‌های افزودن و حذف برای هر دیو
      function addIconsToDivs() {
        document.querySelectorAll(".leftSide > div > div").forEach((div) => {
          div.querySelector(".button-container-add")?.remove();
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container-add");
          buttonContainer.appendChild(createButton("+", () => addNewElement(div)));
          buttonContainer.appendChild(createButton("-", () => removeLastElement(div)));
          div.appendChild(buttonContainer);
        });
      }

      // تابع ایجاد دکمه برای هر h3
      function addParagraphAndListToH3() {
        document.querySelectorAll(".button-container-main").forEach((btn) => btn.remove());
        document.querySelectorAll("h3").forEach((h3) => {
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container-main");
          buttonContainer.appendChild(createButton("افزودن پاراگراف", () => addParagraph(h3)));
          buttonContainer.appendChild(createButton("افزودن لیست", () => addList(h3)));
          buttonContainer.appendChild(createButton("افزودن جدول", () => addTable(h3)));
          if (h3.matches(".section4 > div:nth-child(2) > h3")) {
            buttonContainer.appendChild(createButton("ایجاد نمودار", () => createChart(h3)));
          }
          buttonContainer.appendChild(createButton("حذف آخرین", () => removeLastContent(h3)));
          buttonContainer.appendChild(createButton("حذف همه", () => removeAllContent(h3)));
          h3.parentNode.insertBefore(buttonContainer, h3.nextSibling);
        });
        editAllSections();
      }

      // سایر توابع مورد نیاز
      function createButton(text, onClick) {
        const btn = document.createElement("button");
        btn.innerText = text;
        btn.classList.add("add-btn");
        btn.onclick = onClick;
        return btn;
      }

      function createEditableElement(tag, text) {
        const element = document.createElement(tag);
        element.contentEditable = true;
        element.classList.add("editable");
        element.innerText = text;
        return element;
      }

      function addNewElement(parentDiv) {
        const buttonContainer = parentDiv.querySelector(".button-container-add");
        parentDiv.insertBefore(createEditableElement("h4", "عنوان جدید"), buttonContainer);
        parentDiv.insertBefore(createEditableElement("p", "متن جدید"), buttonContainer);
      }

      function removeLastElement(parentDiv) {
        ["h4", "p"].forEach((tag) => {
          const elements = parentDiv.querySelectorAll(tag);
          if (elements.length) parentDiv.removeChild(elements[elements.length - 1]);
        });
      }

      function addParagraph(h3) {
        h3.parentNode.appendChild(createEditableElement("p", "متن جدید"));
      }

      function addList(h3) {
        const newUl = createEditableElement("ul", "");
        newUl.innerHTML = "<li>آیتم ۱</li><li>آیتم ۲</li>";
        h3.parentNode.appendChild(newUl);
      }

      function addTable(h3) {
        if (h3.parentNode.querySelector("table")) {
          alert("یک جدول قبلاً اضافه شده است.");
          return;
        }
        const newTable = document.createElement("table");
        newTable.classList.add("table");
        newTable.innerHTML = `
        <thead>
            <tr>
                <td contenteditable="true" class="editable">سرستون ۱</td>
                <td contenteditable="true" class="editable">سرستون ۲</td>
                <td contenteditable="true" class="editable">سرستون ۳</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۱</td>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۲</td>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۳</td>
            </tr>
        </tbody>`;
        h3.parentNode.appendChild(newTable);
        addTableButtons();
      }

      function createChart(h3) {
        if (document.querySelector(".chartContainer")) return;
        const chartContainer = document.createElement("div");
        chartContainer.classList.add("chartContainer");
        chartContainer.innerHTML = `<canvas id="Chart">برای نمایش نمودار، صفحه را رفرش کنید یا مرورگر را به‌روز کنید.</canvas>`;
        h3.parentNode.appendChild(chartContainer);
        initializeChart();
      }

      function removeLastContent(h3) {
        const siblings = Array.from(h3.parentNode.childNodes);
        for (let i = siblings.length - 1; i >= 0; i--) {
          const elem = siblings[i];
          if (elem !== h3 && !elem.classList?.contains("button-container-main") && ["P", "UL", "TABLE", "DIV"].includes(elem.nodeName) && (elem.nodeName !== "DIV" || elem.classList.contains("chartContainer"))) {
            elem.remove();
            break;
          }
        }
        addTableButtons();
      }

      function removeAllContent(h3) {
        const parent = h3.parentNode;
        if (parent) {
          parent.innerHTML = "";
          const addHeaderButton = createButton("ایجاد هدر", function () {
            parent.appendChild(createEditableElement("h3", "هدر جدید"));
            addParagraphAndListToH3();
            this.remove();
          });
          parent.appendChild(addHeaderButton);
        }
      }

      // توابع مربوط به جداول
      function addTableButtons() {
        document.querySelectorAll(".button-container").forEach((btn) => btn.remove());
        document.querySelectorAll(".table").forEach((table) => {
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container");
          buttonContainer.appendChild(createButton("+ ردیف", () => addTableRow(table)));
          buttonContainer.appendChild(createButton("- ردیف", () => removeTableRow(table)));
          buttonContainer.appendChild(createButton("+ سلول", () => addTableCell(table)));
          buttonContainer.appendChild(createButton("- سلول", () => removeTableCell(table)));
          buttonContainer.appendChild(createButton("+ سلول هدر", () => addTableHeaderCell(table)));
          buttonContainer.appendChild(createButton("- سلول هدر", () => removeTableHeaderCell(table)));
          table.parentNode.insertBefore(buttonContainer, table.nextSibling);
        });
      }

      function addTableRow(table) {
        const tbody = table.querySelector("tbody") || table.appendChild(document.createElement("tbody"));
        const newRow = document.createElement("tr");
        const numCells = table.querySelector("thead tr")?.children.length || 3;
        for (let i = 0; i < numCells; i++) {
          newRow.appendChild(createEditableElement("td", "سلول جدید"));
        }
        tbody.appendChild(newRow);
      }

      function addTableCell(table) {
        const lastRow = table.querySelector("tbody tr:last-of-type") || addTableRow(table);
        lastRow.appendChild(createEditableElement("td", "سلول جدید"));
      }

      function removeTableRow(table) {
        const tbody = table.querySelector("tbody");
        const lastRow = tbody?.lastElementChild;
        if (lastRow) {
          tbody.removeChild(lastRow);
          if (!tbody.children.length) tbody.remove();
        }
      }

      function removeTableCell(table) {
        const lastRow = table.querySelector("tbody tr:last-of-type");
        const lastCell = lastRow?.lastElementChild;
        if (lastCell) {
          lastRow.removeChild(lastCell);
          if (!lastRow.children.length) removeTableRow(table);
        }
      }

      function addTableHeaderCell(table) {
        const headerRow = table.querySelector("thead tr");
        if (headerRow) {
          headerRow.appendChild(createEditableElement("td", "سرستون جدید"));
        } else {
          console.warn("سرستونی برای اضافه کردن وجود ندارد.");
        }
        if (!table.querySelector("tbody tr")) addTableRow(table);
      }

      function removeTableHeaderCell(table) {
        const headerRow = table.querySelector("thead tr");
        const lastCell = headerRow?.lastElementChild;
        if (lastCell) {
          headerRow.removeChild(lastCell);
          if (!headerRow.children.length) console.warn("سرستونی برای حذف وجود ندارد.");
        }
      }

      // رویداد بارگذاری صفحه
      document.addEventListener("DOMContentLoaded", () => {
        editAllSections();
        addIconsToDivs();
        addParagraphAndListToH3();
        addTableButtons();
      });
      /*-----------------*/
      function loadJSON(callback) {
        const xhr = new XMLHttpRequest();
        xhr.overrideMimeType("application/json");
        xhr.open("GET", "../products/products.json", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            callback(xhr.responseText);
          }
        };
        xhr.send(null);
      }

      function populateProductsTitles(data) {
        const jsonData = JSON.parse(data);
        const categories = jsonData.categories;
        const productSelect = document.getElementById("productSelect");
        let productCount = 0;
        const uniqueProducts = new Set();

        categories.forEach((category) => {
          category.products.forEach((product) => {
            const productKey = product.name.fa;
            if (!uniqueProducts.has(productKey)) {
              uniqueProducts.add(productKey);
              productCount++;
              const option = document.createElement("option");
              option.textContent = productCount + ". " + product.name.fa;
              option.value = product.url;
              productSelect.appendChild(option);
            }
          });
        });
      }

      function fetchProductPage(productUrl) {
        fetch(`../products/${productUrl}.html`)
          .then((response) => response.text())
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const mainProductsContainer = doc.querySelector("main");

            if (mainProductsContainer) {
              const mainProductsContainerHTML = mainProductsContainer.innerHTML;
              const smoothWrapper = document.getElementById("smooth-wrapper");
              smoothWrapper.innerHTML = mainProductsContainerHTML;

              let labels = [];
              let labelYellow = "";
              let labelRed = "";
              let dataYellow = [];
              let dataRed = [];
              let titleText = "";

              const scriptTags = doc.querySelectorAll("script");
              scriptTags.forEach((scriptTag) => {
                const scriptContent = scriptTag.innerHTML;

                eval(scriptContent);

                window.labels = labels;
                window.labelYellow = labelYellow;
                window.labelRed = labelRed;
                window.dataYellow = dataYellow;
                window.dataRed = dataRed;
                window.titleText = titleText;
              });

              const otherProductSection = smoothWrapper.querySelector("section.otherProduct");
              if (otherProductSection) {
                otherProductSection.remove();
              }
              editAllSections();
              addParagraphAndListToH3();
              addIconsToDivs();
              addRemoveAllButtonToEmptyDivs();
              initializeChart();
            } else {
              console.error("Main container not found in the product page.");
            }
          })
          .catch((error) => {
            console.error("Error fetching the content:", error);
          });
      }

      document.getElementById("productSelect").addEventListener("change", function () {
        const selectedUrl = this.value;
        if (selectedUrl) {
          fetchProductPage(selectedUrl);
          pageUrl = selectedUrl;
        }
      });

      loadJSON(populateProductsTitles);

      /*------------------*/
      const toggleContainerButton = document.getElementById("toggleContainerButton");
      toggleContainerButton.addEventListener("click", function () {
        const contentContainers = document.querySelectorAll(".editPanelBtn > :not(#toggleContainerButton)");
        contentContainers.forEach(function (contentContainer) {
          if (contentContainer.classList.contains("panelHidden")) {
            contentContainer.classList.remove("panelHidden");
            toggleContainerButton.classList.remove("active");
          } else {
            contentContainer.classList.add("panelHidden");
            toggleContainerButton.classList.add("active");
          }
        });
      });
    </script>
  </body>
</html>
