<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex,indexifembedded" />
    <title>ادمین - صفحه ادیت محصولات</title>

    <link rel="icon" href="../assets/VectorLogo-favicon.svg" type="image/svg+xml" sizes="any" />

    <link rel="stylesheet" href="../src/css/main.css?v=1.0.14" />
    <link rel="stylesheet" href="../src/css/products.css?v=1.0.14" />

    <script src="../src/js/chart.js"></script>
    <script defer="" src="../src/js/lineChart.js"></script>

    <style>
      main {
        padding-bottom: 15vmin;
      }

      .edit-btn,
      .save-btn {
        margin: 5px;
        padding: 5px 10px;
        cursor: pointer;
      }

      .edit-btn {
        background-color: #4caf50;
        color: white;
      }

      .save-btn {
        background-color: #008cba;
        color: white;
        display: none;
      }

      .editable {
        border: 1px dashed #000;
      }

      .add-btn {
        margin: 2px;
        padding: 2px 4px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 14px;
      }

      .add-btn:hover {
        background-color: #45a049;
      }

      .button-container {
        z-index: 99;
        position: relative;
      }

      .hidden {
        display: none;
      }

      #editPanel {
        position: fixed;
        top: 20%;
        left: 20%;
        width: 60%;
        padding: 20px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        z-index: 1000;
      }

      #editPanel label {
        display: block;
        margin-top: 10px;
      }

      #editPanel input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
      }

      .editPanelBtn {
        position: fixed;
        width: 500px;
        bottom: 1vmin;
        left: 1vmin;

        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        direction: rtl;
        padding: 1vmin;
        border-radius: 5px;
        background-color: #f0f0f0;
        box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;

        font-family: rokh;
      }

      .editPanelBtn button,
      .editPanelBtn input[type="file"],
      .editPanelBtn select {
        background-color: #088f9e;
        color: #fff;
        border: none;
        padding: 5px 10px;
        margin-bottom: 5px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
        transition: background-color 0.3s;
        width: 100%;
      }

      .editPanelBtn hr {
        margin-bottom: 5px;
      }

      .editPanelBtn button:hover,
      .editPanelBtn input[type="file"]:hover,
      .editPanelBtn select:hover {
        background-color: #066f7a;
      }

      .editPanelBtn span {
        font-size: 16px;
        font-family: rokh;
        text-transform: capitalize;
        margin-bottom: 5px;
      }

      #message {
        margin-top: 10px;
        width: 100%;
        border: 2px black solid;
        border-radius: 5px;
        padding: 6px;
        background: white;
        max-height: 12em;
        overflow-y: auto;
      }

      #message::-webkit-scrollbar {
        display: block;
      }

      input[type="file"]::file-selector-button {
        border: white 1px solid;
        color: white;
        background: transparent;
        border-radius: 5px;
      }

      input[type="file"]:hover::file-selector-button {
        border: black 1px solid;
        color: black;
      }

      textarea,
      input {
        background: transparent;
        width: 100%;
        border: 1px solid rgb(171, 171, 171);
        direction: rtl;
        font-family: Arial, YekanBakhFaNum, Helvetica, sans-serif;
        padding: 5px;
      }
      textarea {
        resize: vertical;
      }

      select:hover {
        color: white !important;
      }

      .panelHidden {
        display: none;
      }
      .containerHidden {
        display: none;
      }
      .fleshDown {
        content: url(../assets/VectorFlesh5.svg);
        vertical-align: middle;
        height: 100%;
        width: 20px;
        height: 20px;
        min-width: 10p;
        padding: 3px;
        border: 1px solid black;
        border-radius: 50vmin;
        margin-left: auto;
        transition: 0.5s ease;
      }

      .fleshDown.active {
        transform: rotate(180deg);
      }

      .button-container-main > button {
        font-family: YekanBakhFaNum;
        font-size: 12px;
      }
      .add-btn {
        font-family: YekanBakhFaNum;
        font-size: 12px;
        text-wrap: nowrap;
      }
      .editPanelBtn > div:first-of-type {
        display: flex;
        flex-direction: row;
        gap: 5px;
      }
      .otherProduct {
        display: none;
      }
      .hero img {
        position: relative;
      }
      .hero img::after {
        content: "";
        position: absolute;
        inset: -10px 0 0 0;
        background-image: url("");
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
      }
    </style>
  </head>

  <body>
    <main id="smooth-wrapper"></main>

    <div class="editPanelBtn">
      <span id="toggleContainerButton" class="fleshDown"></span>
      <hr />
      <div>
        <button id="addProductButton" onclick="prepareNewProductPage()">
          <span class="text-container">
            <span class="text">افزودن محصول</span>
          </span>
        </button>
        <button id="editProductButton">
          <span class="text-container">
            <span class="text">ویرایش محصول</span>
          </span>
        </button>
        <button id="deleteProductButton">
          <span class="text-container">
            <span class="text">حذف محصول</span>
          </span>
        </button>
      </div>
      <hr />
      <div id="editProductsContainer" class="containerHidden">
        <span>ویرایش محصول:</span>
        <select id="productSelect">
          <option value="" selected disabled>انتخاب کنید</option>
        </select>
        <hr />
        <span>عنوان فارسی محصول:</span>
        <input type="text" id="titleFaEdit" />
        <hr />

        <span>عنوان انگلیسی محصول:</span>
        <input type="text" id="titleEnEdit" />
        <hr />

        <span>توضیحات محصول:</span>
        <textarea id="descriptionEdit" rows="4"></textarea>

        <hr />
        <span>تصویر محصول:</span>
        <input type="file" title="file" id="imageEdit" name="uploadFile" accept=".png, .jpg" />
        <hr />

        <span>کاتالوگ محصول:</span>
        <input type="file" title="file" id="fileEdit" name="uploadFile" accept=".pdf" />
        <hr />

        <button id="toggleButton">
          <span class="text-container">
            <span class="text">ویرایش داده‌های نمودار</span>
          </span>
        </button>
        <hr />
        <button onclick="submitProductEdits()">
          <span class="text-container">
            <span class="text">ذخیره</span>
          </span>
        </button>
        <div id="editPanel" class="hidden">
          <label for="labels">برچسب‌ها (با کاما جدا شوند):</label>
          <input type="text" id="labels" />
          <label for="labelYellow">برچسب زرد:</label>
          <input type="text" id="labelYellow" />
          <label for="labelRed">برچسب قرمز:</label>
          <input type="text" id="labelRed" />
          <label for="dataYellow">داده‌های زرد (با کاما جدا شوند):</label>
          <input type="text" id="dataYellow" />
          <label for="dataRed">داده‌های قرمز (با کاما جدا شوند):</label>
          <input type="text" id="dataRed" />
          <label for="titleText">عنوان:</label>
          <input type="text" id="titleText" />
          <button id="saveButton">ذخیره</button>
        </div>
      </div>
      <div id="addProductsContainer" class="containerHidden">
        <span style="font-weight: 600">افزودن محصول:</span>
        <hr />
        <span>آدرس صفحه:</span>
        <input type="text" id="newPageUrl" name="newPageUrl" />
        <hr />
        <span>عنوان فارسی:</span>
        <input type="text" id="newTitleFa" name="newTitleFa" />
        <span>عنوان انگلیسی:</span>
        <input type="text" id="newTitleEn" name="newTitleEn" />
        <hr />
        <span>توضیحات:</span>
        <textarea id="newDescription" name="newDescription" rows="5"></textarea>
        <hr />
        <label for="newCategory">دسته‌بندی:</label>
        <select id="newCategorySelector">
          <option value="" selected disabled>انتخاب کنید</option>
          <!-- گزینه‌های دسته‌بندی را با توجه به داده‌های خود اضافه کنید -->
        </select>
        <hr />
        <span>تصویر:</span>
        <input type="file" id="newImageFile" name="newImageFile" accept=".png, .jpg" />
        <hr />
        <span>کاتالوگ محصول:</span>
        <input type="file" id="newPdfFile" name="newPdfFile" accept=".pdf" />
        <hr />
        <hr />
        <span>دریافت دیتا محصولات موجود:</span>
        <select id="fetchExistingDataSelect">
          <option value="" selected disabled>انتخاب کنید</option>
        </select>
        <hr />
        <button onclick="submitNewProduct()">
          <span class="text-container">
            <span class="text">ذخیره محصول جدید</span>
          </span>
        </button>
      </div>
      <div id="deleteProductsContainer" class="containerHidden">
        <span style="font-weight: 600">حذف محصول:</span>
        <hr />
        <span>انتخاب محصول:</span>
        <select id="deleteProductSelect">
          <option value="" selected disabled>انتخاب کنید</option>
        </select>
        <hr />
        <button onclick="deleteSelectedProduct()">
          <span class="text-container">
            <span class="text">حذف محصول</span>
          </span>
        </button>
      </div>
      <div id="message"></div>
    </div>

    <script>
      const username = sessionStorage.getItem("username");
      const password = sessionStorage.getItem("password");

      document.addEventListener("DOMContentLoaded", function () {
        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        fetch("login.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((text) => {
            if (text != "true") {
              document.body.innerHTML = "";

              document.body.innerHTML =
                '<a style="display: block; width: 100%; text-align: center; font-size: larger;" href="index.html">لاگین کنید</a>';
            }
          })
          .catch((error) => console.error("Error:", error));
      });

      var pageUrl = "";

      function displayMessage(message) {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML += message + "<br>";
        messageDiv.scrollTop = messageDiv.scrollHeight;
      }

      // تابع حذف ویژگی‌های edit و تمیز کردن المان‌ها
      function cleanEditables() {
        const selectors = "h1, h2, h3, h4, p, ul, td";
        document.querySelectorAll(selectors).forEach((element) => {
          element.removeAttribute("contentEditable");
          element.classList.remove("editable");
          if (!element.classList.length) element.removeAttribute("class");
        });
        [".button-container-add", ".button-container-main", ".button-container", ".add-btn"].forEach((selector) => {
          document.querySelectorAll(selector).forEach((btn) => btn.remove());
        });
      }

      // تابع پر کردن ورودی‌ها
      function populateInputs() {
        ["labels", "labelYellow", "labelRed", "dataYellow", "dataRed", "titleText"].forEach((id) => {
          document.getElementById(id).value = window[id];
        });
      }

      // رویداد برای دکمه نمایش/مخفی کردن پنل ویرایش
      document.getElementById("toggleButton").addEventListener("click", () => {
        const panel = document.getElementById("editPanel");
        panel.classList.toggle("hidden");
        if (!panel.classList.contains("hidden")) populateInputs();
      });

      // رویداد برای دکمه ذخیره تغییرات
      document.getElementById("saveButton").addEventListener("click", () => {
        window.labels = document
          .getElementById("labels")
          .value.split(",")
          .map((item) => item.trim());
        ["labelYellow", "labelRed", "titleText"].forEach((id) => {
          window[id] = document.getElementById(id).value;
        });
        ["dataYellow", "dataRed"].forEach((id) => {
          window[id] = document.getElementById(id).value.split(",").map(Number);
        });
        initializeChart();
        document.getElementById("editPanel").classList.add("hidden");
      });

      // تابع فعال‌سازی ویرایش همه بخش‌ها
      function editAllSections() {
        document.querySelectorAll("h1, h2, h3, h4, p, ul, td").forEach((element) => {
          element.contentEditable = true;
          element.classList.add("editable");
        });
      }

      // تابع ایجاد دکمه‌های افزودن و حذف برای هر دیو
      function addIconsToDivs() {
        document.querySelectorAll(".leftSide > div > div").forEach((div) => {
          div.querySelector(".button-container-add")?.remove();
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container-add");
          buttonContainer.appendChild(createButton("+", () => addNewElement(div)));
          buttonContainer.appendChild(createButton("-", () => removeLastElement(div)));
          div.appendChild(buttonContainer);
        });
      }

      // تابع ایجاد دکمه برای هر h3
      function addParagraphAndListToH3() {
        document.querySelectorAll(".button-container-main").forEach((btn) => btn.remove());
        document.querySelectorAll("h3").forEach((h3) => {
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container-main");
          buttonContainer.appendChild(createButton("افزودن پاراگراف", () => addParagraph(h3)));
          buttonContainer.appendChild(createButton("افزودن لیست", () => addList(h3)));
          buttonContainer.appendChild(createButton("افزودن جدول", () => addTable(h3)));
          if (h3.matches(".section4 > div:nth-child(2) > h3")) {
            buttonContainer.appendChild(createButton("ایجاد نمودار", () => createChart(h3)));
          }
          buttonContainer.appendChild(createButton("حذف آخرین", () => removeLastContent(h3)));
          buttonContainer.appendChild(createButton("حذف همه", () => removeAllContent(h3)));
          h3.parentNode.insertBefore(buttonContainer, h3.nextSibling);
        });
        editAllSections();
      }

      // سایر توابع مورد نیاز
      function createButton(text, onClick) {
        const btn = document.createElement("button");
        btn.innerText = text;
        btn.classList.add("add-btn");
        btn.onclick = onClick;
        return btn;
      }

      function createEditableElement(tag, text) {
        const element = document.createElement(tag);
        element.contentEditable = true;
        element.classList.add("editable");
        element.innerText = text;
        return element;
      }

      function addNewElement(parentDiv) {
        const buttonContainer = parentDiv.querySelector(".button-container-add");
        parentDiv.insertBefore(createEditableElement("h4", "عنوان جدید"), buttonContainer);
        parentDiv.insertBefore(createEditableElement("p", "متن جدید"), buttonContainer);
      }

      function removeLastElement(parentDiv) {
        ["h4", "p"].forEach((tag) => {
          const elements = parentDiv.querySelectorAll(tag);
          if (elements.length) parentDiv.removeChild(elements[elements.length - 1]);
        });
      }

      function addParagraph(h3) {
        h3.parentNode.appendChild(createEditableElement("p", "متن جدید"));
      }

      function addList(h3) {
        const newUl = createEditableElement("ul", "");
        newUl.innerHTML = "<li>آیتم ۱</li><li>آیتم ۲</li>";
        h3.parentNode.appendChild(newUl);
      }

      function addTable(h3) {
        if (h3.parentNode.querySelector("table")) {
          alert("یک جدول قبلاً اضافه شده است.");
          return;
        }
        const newTable = document.createElement("table");
        newTable.classList.add("table");
        newTable.innerHTML = `
        <thead>
            <tr>
                <td contenteditable="true" class="editable">سرستون ۱</td>
                <td contenteditable="true" class="editable">سرستون ۲</td>
                <td contenteditable="true" class="editable">سرستون ۳</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۱</td>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۲</td>
                <td contenteditable="true" class="editable">ردیف ۱، سلول ۳</td>
            </tr>
        </tbody>`;
        h3.parentNode.appendChild(newTable);
        addTableButtons();
      }

      function createChart(h3) {
        if (document.querySelector(".chartContainer")) return;
        const chartContainer = document.createElement("div");
        chartContainer.classList.add("chartContainer");
        chartContainer.innerHTML = `<canvas id="Chart">برای نمایش نمودار، صفحه را رفرش کنید یا مرورگر را به‌روز کنید.</canvas>`;
        h3.parentNode.appendChild(chartContainer);
        initializeChart();
      }

      function removeLastContent(h3) {
        const siblings = Array.from(h3.parentNode.childNodes);
        for (let i = siblings.length - 1; i >= 0; i--) {
          const elem = siblings[i];
          if (
            elem !== h3 &&
            !elem.classList?.contains("button-container-main") &&
            ["P", "UL", "TABLE", "DIV"].includes(elem.nodeName) &&
            (elem.nodeName !== "DIV" || elem.classList.contains("chartContainer"))
          ) {
            elem.remove();
            break;
          }
        }
        addTableButtons();
      }

      function removeAllContent(h3) {
        const parent = h3.parentNode;
        if (parent) {
          parent.innerHTML = "";
          const addHeaderButton = createButton("ایجاد هدر", function () {
            parent.appendChild(createEditableElement("h3", "هدر جدید"));
            addParagraphAndListToH3();
            this.remove();
          });
          parent.appendChild(addHeaderButton);
        }
      }

      // توابع مربوط به جداول
      function addTableButtons() {
        document.querySelectorAll(".button-container").forEach((btn) => btn.remove());
        document.querySelectorAll(".table").forEach((table) => {
          const buttonContainer = document.createElement("div");
          buttonContainer.classList.add("button-container");
          buttonContainer.appendChild(createButton("+ ردیف", () => addTableRow(table)));
          buttonContainer.appendChild(createButton("- ردیف", () => removeTableRow(table)));
          buttonContainer.appendChild(createButton("+ سلول", () => addTableCell(table)));
          buttonContainer.appendChild(createButton("- سلول", () => removeTableCell(table)));
          buttonContainer.appendChild(createButton("+ سلول هدر", () => addTableHeaderCell(table)));
          buttonContainer.appendChild(createButton("- سلول هدر", () => removeTableHeaderCell(table)));
          table.parentNode.insertBefore(buttonContainer, table.nextSibling);
        });
      }

      function addTableRow(table) {
        const tbody = table.querySelector("tbody") || table.appendChild(document.createElement("tbody"));
        const newRow = document.createElement("tr");
        const numCells = table.querySelector("thead tr")?.children.length || 3;
        for (let i = 0; i < numCells; i++) {
          newRow.appendChild(createEditableElement("td", "سلول جدید"));
        }
        tbody.appendChild(newRow);
      }

      function addTableCell(table) {
        const lastRow = table.querySelector("tbody tr:last-of-type") || addTableRow(table);
        lastRow.appendChild(createEditableElement("td", "سلول جدید"));
      }

      function removeTableRow(table) {
        const tbody = table.querySelector("tbody");
        const lastRow = tbody?.lastElementChild;
        if (lastRow) {
          tbody.removeChild(lastRow);
          if (!tbody.children.length) tbody.remove();
        }
      }

      function removeTableCell(table) {
        const lastRow = table.querySelector("tbody tr:last-of-type");
        const lastCell = lastRow?.lastElementChild;
        if (lastCell) {
          lastRow.removeChild(lastCell);
          if (!lastRow.children.length) removeTableRow(table);
        }
      }

      function addTableHeaderCell(table) {
        const headerRow = table.querySelector("thead tr");
        if (headerRow) {
          headerRow.appendChild(createEditableElement("td", "سرستون جدید"));
        } else {
          console.warn("سرستونی برای اضافه کردن وجود ندارد.");
        }
        if (!table.querySelector("tbody tr")) addTableRow(table);
      }

      function removeTableHeaderCell(table) {
        const headerRow = table.querySelector("thead tr");
        const lastCell = headerRow?.lastElementChild;
        if (lastCell) {
          headerRow.removeChild(lastCell);
          if (!headerRow.children.length) console.warn("سرستونی برای حذف وجود ندارد.");
        }
      }

      // رویداد بارگذاری صفحه
      document.addEventListener("DOMContentLoaded", () => {
        editAllSections();
        addIconsToDivs();
        addParagraphAndListToH3();
        addTableButtons();
      });
      /*-----------------*/
      function loadJSON(callback) {
        const xhr = new XMLHttpRequest();
        xhr.overrideMimeType("application/json");
        xhr.open("GET", "../serverAssets/products.json", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            callback(xhr.responseText);
          }
        };
        xhr.send(null);
      }

      function populateProductsTitles(data) {
        const jsonData = JSON.parse(data);
        const categories = jsonData.categories;
        const productSelect = document.getElementById("productSelect");
        let productCount = 0;

        categories.forEach((category) => {
          category.products.forEach((product) => {
            const productKey = product.name.fa;
            productCount++;
            const option = document.createElement("option");
            option.textContent = productCount + ". " + product.name.fa;
            option.value = product.url;
            productSelect.appendChild(option);
          });
        });
      }
      function populateCategorySelector(data) {
        const jsonData = JSON.parse(data);
        const categories = jsonData.categories;
        const categorySelector = document.getElementById("newCategorySelector");

        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.name; // یا شناسه‌ی منحصربه‌فرد دسته
          option.textContent = `${category.name} (${category.faName})`;
          categorySelector.appendChild(option);
        });
      }

      loadJSON(populateProductsTitles);
      loadJSON(populateCategorySelector);
      loadJSON(populateDeleteProductSelect);

      function fetchProductPage(productUrl) {
        fetch(`../products/${productUrl}.html`)
          .then((response) => response.text())
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const mainProductsContainer = doc.querySelector("main");

            if (mainProductsContainer) {
              const mainProductsContainerHTML = mainProductsContainer.innerHTML;
              const smoothWrapper = document.getElementById("smooth-wrapper");
              smoothWrapper.innerHTML = mainProductsContainerHTML;

              let labels = [];
              let labelYellow = "";
              let labelRed = "";
              let dataYellow = [];
              let dataRed = [];
              let titleText = "";

              const scriptTags = doc.querySelectorAll("script");
              scriptTags.forEach((scriptTag) => {
                const scriptContent = scriptTag.innerHTML;

                eval(scriptContent);

                window.labels = labels;
                window.labelYellow = labelYellow;
                window.labelRed = labelRed;
                window.dataYellow = dataYellow;
                window.dataRed = dataRed;
                window.titleText = titleText;
              });

              editAllSections();
              addParagraphAndListToH3();
              addIconsToDivs();
              initializeChart();
            } else {
              console.error("Main container not found in the product page.");
            }
          })
          .catch((error) => {
            console.error("Error fetching the content:", error);
          });
      }

      document.getElementById("productSelect").addEventListener("change", handleProductChange);

      function handleProductChange() {
        const selectedUrl = this.value;
        if (selectedUrl) {
          loadJSON((data) => {
            const jsonData = JSON.parse(data);
            jsonData.categories.forEach((category) => {
              category.products.forEach((product) => {
                if (product.url === selectedUrl) {
                  document.getElementById("titleFaEdit").value = product.name.fa || "";
                  document.getElementById("titleEnEdit").value = product.name.en || "";
                  document.getElementById("descriptionEdit").value = product.description || "";

                  fetchProductPage(selectedUrl);
                  pageUrl = selectedUrl;
                }
              });
            });
          });
        }
      }

      /*------ تغییر وضعیت نمایش پنل------------*/
      const toggleContainerButton = document.getElementById("toggleContainerButton");
      const contentContainers = document.querySelectorAll(".editPanelBtn :not(#toggleContainerButton)");

      toggleContainerButton.addEventListener("click", () => {
        contentContainers.forEach((contentContainer) => contentContainer.classList.toggle("panelHidden"));
        toggleContainerButton.classList.toggle("active");
      });

      const buttons = [
        { button: document.getElementById("addProductButton"), container: document.getElementById("addProductsContainer") },
        { button: document.getElementById("editProductButton"), container: document.getElementById("editProductsContainer") },
        { button: document.getElementById("deleteProductsContainer"), container: document.getElementById("deleteProductsContainer") },
      ];

      function hideAllSections() {
        buttons.forEach(({ container }) => container.classList.add("containerHidden"));
      }

      buttons.forEach(({ button, container }) => {
        button.addEventListener("click", () => {
          hideAllSections();
          container.classList.remove("containerHidden");
        });
      });
      //---------// Utility function to sanitize URLs

      // تابعی برای اعتبارسنجی ورودی URL
      function validateUrlInput(value) {
        value = value.toLowerCase().replace(/\s+/g, "-");
        const parts = value.split(".");
        let filename = parts[0].replace(/[^a-z0-9\-]/g, "");
        let extension = parts.length > 1 ? parts.pop().replace(/[^a-z0-9]/g, "") : "";
        return extension ? `${filename}.${extension}` : filename;
      }

      // تابعی برای دریافت تاریخ و زمان فعلی به فرمت YYYYMMDDHHMMSS
      function getCurrentDateTime() {
        const today = new Date();
        const year = today.getFullYear();
        const month = `0${today.getMonth() + 1}`.slice(-2);
        const day = `0${today.getDate()}`.slice(-2);
        const hours = `0${today.getHours()}`.slice(-2);
        const minutes = `0${today.getMinutes()}`.slice(-2);
        const seconds = `0${today.getSeconds()}`.slice(-2);
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
      }

      // تابعی برای افزودن یا به‌روزرسانی پارامتر ورژن در URL
      function addOrUpdateVersion(url, version) {
        try {
          // ایجاد یک آبجکت URL با استفاده از window.location.origin به عنوان مبنا
          const urlObj = new URL(url, window.location.origin);
          // تنظیم یا افزودن پارامتر 'v'
          urlObj.searchParams.set("v", version);
          // بازگرداندن مسیر و پارامترهای URL بدون پروتکل و دامنه
          return urlObj.pathname + urlObj.search;
        } catch (e) {
          // در صورت بروز خطا (مثلاً URL غیرمعتبر)، از روش دستی استفاده می‌کنیم
          const hasQuery = url.includes("?");
          const baseUrl = hasQuery ? url.split("?")[0] : url;
          const params = new URLSearchParams(hasQuery ? url.split("?")[1] : "");
          params.set("v", version);
          return `${baseUrl}?${params.toString()}`;
        }
      }

      // پیکربندی‌های Mapping برای فیلدهای ورودی و هدف‌های آن‌ها
      const bindings = [
        {
          inputId: "newTitleFa",
          selector: ".hero h1",
          attribute: "textContent",
          updater: null, // بدون اپدیتر اضافی
          updateAlt: true,
        },
        {
          inputId: "newTitleEn",
          selector: ".hero h2",
          attribute: "textContent",
          updater: null,
          updateAlt: true,
        },
        {
          inputId: "newDescription",
          selector: ".section2 > div:first-child > p",
          attribute: "textContent",
          updater: null,
          updateAlt: false,
        },
        {
          inputId: "newPageUrl",
          selector: ".hero img",
          attribute: "src",
          updater: (value) => `../assets/productImg/${validateUrlInput(value)}`,
          additional: {
            selector: ".section2 > div > a",
            attribute: "href",
            valueMapper: (value) => {
              const filename = validateUrlInput(value).split(".")[0];
              return `../serverAssets/productCatalogue/${filename}.pdf`;
            },
          },
        },
        // Binding جدید برای imageEdit بدون استفاده از data-original-src
        {
          inputId: "imageEdit",
          selector: ".hero img",
          attribute: "src",
          updater: (file) => {
            if (file && file[0]) {
              const imgElement = document.querySelector(".hero img");
              if (imgElement) {
                const currentSrc = imgElement.getAttribute("src");
                const newVersion = getCurrentDateTime();
                const updatedSrc = addOrUpdateVersion(currentSrc, newVersion);
                imgElement.src = updatedSrc;
                updateImageAlt();
              }
            }
          },
          updateAlt: true,
        },
        // ورودی‌های ویرایش
        {
          inputId: "titleFaEdit",
          selector: ".hero h1",
          attribute: "textContent",
          updater: null,
          updateAlt: true,
          isEdit: true,
        },
        {
          inputId: "titleEnEdit",
          selector: ".hero h2",
          attribute: "textContent",
          updater: null,
          updateAlt: true,
          isEdit: true,
        },
        {
          inputId: "descriptionEdit",
          selector: ".section2 > div:first-child > p",
          attribute: "textContent",
          updater: null,
          updateAlt: false,
          isEdit: true,
        },
      ];

      // تابعی برای بروزرسانی alt تصویر
      function updateImageAlt() {
        const imgElement = document.querySelector(".hero img");
        if (imgElement) {
          const titleFa = document.getElementById("newTitleFa")?.value || document.getElementById("titleFaEdit")?.value || "";
          const titleEn = document.getElementById("newTitleEn")?.value || document.getElementById("titleEnEdit")?.value || "";
          imgElement.alt = `${titleFa} تصویر - ${titleEn} image`;
        }
      }

      // Initialize bindings
      bindings.forEach((binding) => {
        const inputElement = document.getElementById(binding.inputId);
        if (!inputElement) return;

        // انتخاب نوع رویداد
        const eventType = binding.inputId === "imageEdit" ? "change" : "input";

        inputElement.addEventListener(eventType, function () {
          let value;

          if (binding.inputId === "imageEdit") {
            // برای input نوع فایل، فایل انتخاب شده را پاس می‌دهیم
            binding.updater(this.files);
          } else {
            value = this.value;

            if (binding.inputId === "newPageUrl") {
              value = validateUrlInput(value);
              this.value = value; // بازتاب اعتبارسنجی در اینپوت
            }

            document.querySelectorAll(binding.selector).forEach((element) => {
              element[binding.attribute] = binding.updater ? binding.updater(value) : value;
            });

            if (binding.additional) {
              const additionalElement = document.querySelector(binding.additional.selector);
              if (additionalElement) {
                additionalElement[binding.additional.attribute] = binding.additional.valueMapper(value);
              }
            }

            if (binding.updateAlt) {
              updateImageAlt();
            }

            if (binding.isEdit && (binding.inputId === "titleFaEdit" || binding.inputId === "titleEnEdit")) {
              updateImageAlt();
            }
          }
        });
      });

      // اجرای تابع بروزرسانی alt در ابتدای بارگذاری صفحه
      updateImageAlt();
      /*------------------ ادیت صفحه محصولات----------------------*/
      async function submitProductEdits() {
        // حذف خصوصیات و کلاس‌های اضافی از عناصر قابل ویرایش
        const selectors = "h1, h2, h3, h4, p, ul, td";
        document.querySelectorAll(selectors).forEach((element) => {
          element.removeAttribute("contentEditable");
          element.classList.remove("editable");
          if (!element.classList.length) element.removeAttribute("class");
        });

        // حذف دکمه‌ها و اجزای اضافی
        const buttonSelectors = [".button-container-add", ".button-container-main", ".button-container", ".add-btn"];
        buttonSelectors.forEach((selector) => {
          document.querySelectorAll(selector).forEach((btn) => btn.remove());
        });

        // دریافت فایل تصویر محصول
        const imageInput = document.getElementById("imageEdit");
        const imageFile = imageInput.files[0];

        // دریافت فایل PDF محصول
        const pdfInput = document.getElementById("fileEdit");
        const pdfFile = pdfInput.files[0];

        const titleFa = document.getElementById("titleFaEdit").value.trim();
        const titleEn = document.getElementById("titleEnEdit").value.trim();
        const description = document.getElementById("descriptionEdit").value.trim();

        // ایجاد FormData
        const formData = new FormData();
        formData.append("url", pageUrl);
        formData.append("body", document.querySelector("main").innerHTML);
        formData.append("labels", window.labels);
        formData.append("labelYellow", window.labelYellow);
        formData.append("labelRed", window.labelRed);
        formData.append("dataYellow", window.dataYellow);
        formData.append("dataRed", window.dataRed);
        formData.append("titleText", window.titleText);

        formData.append("titleFa", titleFa);
        formData.append("titleEn", titleEn);
        formData.append("description", description);

        formData.append("username", username);
        formData.append("password", password);

        // اضافه کردن فایل تصویر به FormData (در صورت وجود)
        if (imageFile && (imageFile.type === "image/jpeg" || imageFile.type === "image/png")) {
          formData.append("imageFile", imageFile);
        }

        // اضافه کردن فایل PDF به FormData (در صورت وجود)
        if (pdfFile && pdfFile.type === "application/pdf") {
          formData.append("pdfFile", pdfFile);
        }

        // ارسال درخواست به PHP
        try {
          const response = await fetch("productsEdit.php", {
            method: "POST",
            body: formData,
          });
          const text = await response.text();
          displayMessage(text);

          if (text.includes("صفحه و فایل‌ها با موفقیت به‌روزرسانی شدند.")) {
            const productPageUrl = `../products/${pageUrl}.html`;
            window.open(productPageUrl, "_blank");
          }
        } catch (error) {
          displayMessage(error.message);
        }
      }

      /*---------------------------------*/
      function prepareNewProductPage() {
        const pageUrl = document.getElementById("newPageUrl").value.trim();
        const titleEn = document.getElementById("newTitleEn").value.trim();
        const titleFa = document.getElementById("newTitleFa").value.trim();
        const description = document.getElementById("newDescription").value.trim();

        const newProductContent = `
    <div id="smooth-content">
      <section class="hero" data-cursor="pointerWaveBorder">
        <div>
          <h2>${titleEn}</h2>
          <h1>${titleFa}</h1>
        </div>
        <img src="../assets/productImg/${pageUrl}.jpg" alt="${titleFa} تصویر - ${titleEn} image" />
      </section>
      <section class="section2">
        <div>
          <p></p>
          <a href="../serverAssets/productCatalogue/${pageUrl}.pdf" data-cursor="pointerNavbar" target="_blank">
            <span class="iconDownload"></span>
          </a>
        </div>
        <div class="flexGrow"><h3>کاربری</h3></div>
      </section>
      <section class="section3">
        <img src="../assets/VectorProduct.svg" alt="" />
        <div><h3>عملکرد و مزایا</h3><h3>استاندارد ها</h3></div>
        <div class="leftSide"><h3>اطلاعات محصول</h3>
          <div>
              <div>
                <h4>عنوان</h4>
                <p>متن</p>
              </div>
              <div>
                <h4>عنوان</h4>
                <p>متن</p>
              </div>
            </div>
        </div>
      </section>
      <section class="section4">
        <div><h3>اطلاعات عملکرد فنی</h3></div>
        <div><h3>اطلاعات نحوه مصرف</h3></div>
        <div><h3>محدودیت ها</h3></div>
        <div><h3>محیط زیست، سلامت و ایمنی</h3></div>
        <div><h3>مرجع اطلاعات</h3></div>
      </section>
      <section class="otherProduct">
        <div class="otherProductWrapper">
          <div class="mainContainer">
            <h3>دیگر محصولات</h3>
            <div class="otherProductContent"></div>
          </div>
          <div class="otherProductHeader">
            <div class="otherProductArrow disabled arrow-next"></div>
            <div class="otherProductArrow arrow-prev"></div>
          </div>
        </div>
      </section>
    </div>
  `;

        // اضافه کردن محتوای جدید به main
        const smoothWrapper = document.getElementById("smooth-wrapper");
        smoothWrapper.innerHTML = newProductContent;

        // فعال کردن دکمه‌ها و قابلیت ویرایش

        editAllSections();
        addParagraphAndListToH3();
        addIconsToDivs();
        initializeChart();

        // نمایش پیام موفقیت
        displayMessage("محصول جدید به صفحه اضافه شد. اکنون می‌توانید محتوای آن را ویرایش کنید.");
      }

      async function submitNewProduct() {
        // دریافت اطلاعات مورد نیاز
        const pageUrl = document.getElementById("newPageUrl").value.trim();
        const titleFa = document.getElementById("newTitleFa").value.trim();
        const titleEn = document.getElementById("newTitleEn").value.trim();
        const description = document.getElementById("newDescription").value.trim();
        const category = document.getElementById("newCategorySelector").value;
        const imageFile = document.getElementById("newImageFile").files[0];
        const pdfFile = document.getElementById("newPdfFile").files[0];

        // بررسی اینکه فیلدهای ضروری پر شده باشند
        if (!pageUrl || !titleFa || !titleEn || !description || !category) {
          displayMessage("لطفاً تمامی فیلدهای مورد نیاز را تکمیل کنید.");
          return;
        }

        // پاک‌سازی ویژگی‌های ویرایش و دکمه‌های اضافی در محدوده smooth-wrapper
        cleanEditables();

        // دریافت محتوای newProductContent پس از پاکسازی
        const smoothWrapper = document.getElementById("smooth-content");
        const newProductContent = smoothWrapper.innerHTML;
        console.log(newProductContent);
        // ایجاد FormData برای ارسال به سرور
        const formData = new FormData();
        formData.append("url", pageUrl);
        formData.append("newProductContent", newProductContent);
        formData.append("titleFa", titleFa);
        formData.append("titleEn", titleEn);
        formData.append("description", description);
        formData.append("category", category);
        formData.append("username", username);
        formData.append("password", password);

        // اضافه کردن فایل تصویر (در صورت وجود)
        if (imageFile && (imageFile.type === "image/jpeg" || imageFile.type === "image/png")) {
          formData.append("imageFile", imageFile);
        } else {
          displayMessage("لطفاً یک فایل تصویر معتبر برای محصول انتخاب کنید.");
          return;
        }

        // اضافه کردن فایل PDF (در صورت وجود)
        if (pdfFile && pdfFile.type === "application/pdf") {
          formData.append("pdfFile", pdfFile);
        } else {
          displayMessage("لطفاً کاتالوگ محصول را به صورت فایل PDF انتخاب کنید.");
          return;
        }

        // ارسال اطلاعات به سرور
        try {
          const response = await fetch("productAddNew.php", {
            method: "POST",
            body: formData,
          });
          const result = await response.text();
          displayMessage(result);

          if (result.includes("محصول با موفقیت اضافه شد.")) {
            // باز کردن لینک صفحه در صفحه‌ای جدید
            const productPageUrl = `../products/${pageUrl}.html`;
            window.open(productPageUrl, "_blank");
          }
        } catch (error) {
          console.error("Error:", error);
          displayMessage("خطا در افزودن محصول جدید.");
        }
      }
      /*---------------------------------*/
      function populateDeleteProductSelect(data) {
        const jsonData = JSON.parse(data);
        const categories = jsonData.categories;
        const deleteProductSelect = document.getElementById("deleteProductSelect");
        let productCount = 0;
        categories.forEach((category) => {
          category.products.forEach((product) => {
            const productKey = product.name.fa;
            productCount++;
            const option = document.createElement("option");
            option.textContent = productCount + ". " + product.name.fa;
            option.value = product.url;
            deleteProductSelect.appendChild(option);
          });
        });
      }

      // نمایش فرم حذف محصولات هنگام کلیک روی دکمه حذف
      document.getElementById("deleteProductButton").addEventListener("click", () => {
        hideAllSections();
        document.getElementById("deleteProductsContainer").classList.remove("containerHidden");
      });

      // تابع برای حذف محصول انتخاب‌شده
      function deleteSelectedProduct() {
        const selectedProductUrl = document.getElementById("deleteProductSelect").value;
        if (!selectedProductUrl) {
          alert("لطفاً یک محصول را انتخاب کنید.");
          return;
        }

        // پرسیدن تأیید از کاربر
        if (!confirm("آیا از حذف این محصول اطمینان دارید؟")) {
          return;
        }

        // آماده‌سازی داده‌ها برای ارسال به سرور
        const formData = new FormData();
        formData.append("url", selectedProductUrl);
        formData.append("username", username);
        formData.append("password", password);

        // ارسال درخواست به سرور برای حذف محصول
        fetch("productDelete.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((text) => {
            displayMessage(text);
            if (text.includes("محصول با موفقیت حذف شد.")) {
              // حذف محصول از لیست انتخاب
              const deleteProductSelect = document.getElementById("deleteProductSelect");
              const options = deleteProductSelect.options;
              for (let i = 0; i < options.length; i++) {
                if (options[i].value === selectedProductUrl) {
                  deleteProductSelect.remove(i);
                  break;
                }
              }
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            displayMessage("خطا در حذف محصول.");
          });
      }

      const imageEditInput = document.getElementById("newImageFile");

      imageEditInput.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const imageUrl = URL.createObjectURL(file);

        for (const styleSheet of document.styleSheets) {
          try {
            for (const rule of styleSheet.cssRules) {
              if (rule.selectorText === ".hero img::after") {
                rule.style.backgroundImage = `url("${imageUrl}")`;
              }
            }
          } catch (e) {
            console.warn(e);
          }
        }
      });

      function populateFetchExistingDataSelector(data) {
        const jsonData = JSON.parse(data);
        const categories = jsonData.categories;
        const fetchSelect = document.getElementById("fetchExistingDataSelect");
        let productCount = 0;

        categories.forEach((category) => {
          category.products.forEach((product) => {
            productCount++;
            const option = document.createElement("option");
            option.textContent = productCount + ". " + product.name.fa;
            option.value = product.url;
            fetchSelect.appendChild(option);
          });
        });
      }

      function handleFetchExistingDataChange() {
        const selectedUrl = this.value;
        if (!selectedUrl) return;

        loadJSON((data) => {
          const jsonData = JSON.parse(data);
          jsonData.categories.forEach((category) => {
            category.products.forEach((product) => {
              if (product.url === selectedUrl) {
                document.getElementById("newTitleFa").value = product.name.fa || "";
                document.getElementById("newTitleEn").value = product.name.en || "";
                document.getElementById("newDescription").value = product.description || "";
              }
            });
          });
        });

        fetch(`../products/${selectedUrl}.html`)
          .then((response) => response.text())
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const mainProductsContainer = doc.querySelector("main");
            if (mainProductsContainer) {
              const smoothWrapper = document.getElementById("smooth-wrapper");
              smoothWrapper.innerHTML = mainProductsContainer.innerHTML;

              const heroImg = smoothWrapper.querySelector(".hero img");
              if (heroImg) {
                heroImg.src = "";
              }

              editAllSections();
              addParagraphAndListToH3();
              addIconsToDivs();
              initializeChart();
            }
          })
          .catch((error) => {
            console.error("Error fetching product content:", error);
          });
      }
      loadJSON(populateFetchExistingDataSelector);
      document.getElementById("fetchExistingDataSelect").addEventListener("change", handleFetchExistingDataChange);
    </script>
  </body>
</html>
